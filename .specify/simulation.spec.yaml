meta:
  id: rave-simulation
  title: Medidata RAVE Simulation Engine (V3 - TDD/Dynamics)
  version: 3.0.0
  description: |
    Entities, behavior, and dynamics of the simulator with deterministic test hooks and invariants.

entities:
  Study:
    fields:
      id: string
      name: string
      seed: number?
      speed_factor: number
      interval_ms: number
      batch_percentage: number
      structure: StudyStructure
      visits: Visit[]
      queries: QueryConfig

  StudyStructure:
    fields:
      sites: integer
      subjects_per_site: integer

  Visit:
    fields:
      name: string
      day: integer
      forms: string[]
      probability: number
      simulate_missed: boolean
      simulate_delayed: boolean
      max_delay_days: integer?
      partial_forms: boolean
      missing_field_probability: number?

  QueryConfig:
    fields:
      enabled: boolean
      missing_data_probability: number
      out_of_range_probability: number

dynamics:
  subject_progression:
    description: |
      Subjects are seeded per structure.sites * subjects_per_site. On each tick, a random sample
      of subjects (batch_percentage) is selected. For each selected subject, visits are evaluated
      in config order. Missed visits create no forms; delayed visits shift timestamps by 0..max_delay_days.
    deterministic_contract: |
      Given identical (seed, config, ticks), the same sequences of subjects, visits, and form data are produced.
  data_updates:
    description: |
      Each generated form includes realistic values per form type. Partial forms null fields with
      missing_field_probability. Out-of-range values may be generated to trigger queries.
  query_generation:
    description: |
      After each form creation, queries may be created per QueryConfig probabilities.
      Query types include MissingData and OutOfRange.

invariants:
  - name: MissedVisitCreatesNoForms
    rule: "If visit is missed for a subject in a tick, no forms are created for that visit."
  - name: DelayedVisitShiftsTimestamp
    rule: "If simulate_delayed is true, form timestamps shift by integer days 0..max_delay_days inclusive."
  - name: PartialFormsProbability
    rule: "If partial_forms is true, each field becomes null independently with probability missing_field_probability."
  - name: UpdateBatchWithinBounds
    rule: "Per tick, number of updated subjects is floor(N * batch_percentage / 100) with tolerance Â±1."
